---
title: "KIN6520 – Laboratoire I"
subtitle: "Analyse et interprétation d'un test VO₂max"
author: "Votre nom"
date: today
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: true
  typst:
    toc: true
    number-sections: true
    margin:
      x: 2.5cm
      y: 2.5cm
execute:
  echo: false
  warning: false
  message: false
knitr:
  opts_chunk:
    dev: png
    dpi: 150
---

```{r}
#| label: setup
#| include: false

# Chargement des packages nécessaires
library(tidyverse)
library(readxl)

# ============================================================================
# VOTRE FICHIER DE DONNÉES
# ============================================================================
# Consultez le README pour trouver votre fichier selon votre matricule.
# Les fichiers sont dans : data/student_files/
#
# Modifiez la ligne ci-dessous avec votre numéro de fichier (P01 à P15) :

mon_fichier <- "P01"

# ============================================================================
# Ne modifiez rien ci-dessous
data_path <- paste0("data/student_files/", mon_fichier, ".xlsx")
```

# Introduction

*Objectif : Présenter brièvement l'objectif du laboratoire et le rôle du test VO₂max dans l'évaluation de l'endurance aérobie. (~0.5 page)*

<!--
VOTRE TEXTE ICI

Éléments à couvrir :
- Qu'est-ce que le VO₂max et pourquoi est-il mesuré?
- Objectif spécifique de ce laboratoire
- Structure du rapport
-->

---

# Méthodologie analytique

*Objectif : Décrire et justifier vos choix analytiques. (~1.5 pages)*

::: {.callout-note}
## Critère de la grille (3 pts)
**Choix méthodologiques et justification** : Méthodes clairement décrites, justification physiologique cohérente, discussion de l'impact des choix analytiques.
:::

## Données utilisées

Décrivez les données fournies et les variables retenues pour l'analyse.

```{r}
#| label: description-donnees
#| include: false

# ============================================================================
# Importation des données (format simplifié pour les étudiants)
# ============================================================================
# Les fichiers anonymisés contiennent 3 feuilles :
# - "Data" : séries temporelles physiologiques
# - "Participant" : informations démographiques anonymisées
# - "Results" : résumé des résultats COSMED

# Lecture des informations du participant
participant <- read_excel(data_path, sheet = "Participant")

# Lecture des données physiologiques
data_raw <- read_excel(data_path, sheet = "Data")

# Aperçu des données
glimpse(data_raw)
glimpse(participant)
```

```{r}
#| label: afficher-participant

# Afficher les informations du participant
knitr::kable(participant, caption = "Informations du participant (anonymisées)")
```

<!--
Décrivez ici :
- Source et nature des données
- Variables analysées et leurs unités
- Nombre d'observations et durée du test
-->

## Traitement des données

Justifiez vos choix de visualisation et de préparation des données.

```{r}
#| label: nettoyage-donnees

# ============================================================================
# Conversion du temps et préparation des données
# ============================================================================
# Le temps est stocké en "fraction de jour" Excel (1 jour = 86400 secondes)

excel_day_to_sec <- function(x) as.numeric(x) * 86400

# Détecter le type de protocole (vélo vs course)
# Vélo : colonne "Power" présente et utilisée
# Course : colonne "Speed" présente et utilisée
has_power <- "Power" %in% names(data_raw) && any(!is.na(data_raw$Power) & data_raw$Power > 0)
has_speed <- "Speed" %in% names(data_raw) && any(!is.na(data_raw$Speed) & data_raw$Speed > 0)

if (has_power) {

  protocole <- "velo"
  charge_label <- "Puissance (W)"
  charge_var <- "power_w"
} else {

  protocole <- "course"
  charge_label <- "Vitesse (km/h)"
  charge_var <- "speed_kph"
}

# Renommer et préparer les colonnes clés
data <- data_raw |>
  mutate(
    # Conversion du temps en secondes
    time = excel_day_to_sec(t),
    # Renommage pour cohérence avec en_classe.qmd
    vo2 = VO2,
    vco2 = VCO2,
    ve = VE,
    hr = HR,
    rer = RQ,
    phase = Phase,
    # Charge externe (selon le protocole)
    speed_kph = if ("Speed" %in% names(data_raw)) Speed else NA_real_,
    power_w = if ("Power" %in% names(data_raw)) Power else NA_real_,
    # Variable générique pour la charge externe
    charge = if (protocole == "velo") power_w else speed_kph
  ) |>
  # Filtrer les lignes avec données valides
  filter(!is.na(vo2))

# Résumé de la qualité des données
summary_data <- tibble(
  `Protocole détecté` = if (protocole == "velo") "Vélo (ergocycle)" else "Course (tapis roulant)",
  `Nombre d'observations` = nrow(data),
  `Durée totale (min)` = round(max(data$time, na.rm = TRUE) / 60, 1),
  `Pas d'échantillonnage médian (s)` = round(median(diff(data$time), na.rm = TRUE), 2),
  `Valeurs manquantes VO₂ (%)` = round(100 * mean(is.na(data_raw$VO2)), 1)
)

knitr::kable(summary_data, caption = "Qualité de la série temporelle")
```

```{r}
#| label: lissage-donnees

# ============================================================================
# Lissage des données (moyenne mobile)
# ============================================================================
# Le lissage réduit le bruit respiratoire pour mieux estimer le VO₂max

# Calculer le nombre de points pour une fenêtre de ~30 secondes
dt_sec <- median(diff(data$time), na.rm = TRUE)
k_30s <- max(1, round(30 / dt_sec))
k_60s <- max(1, round(60 / dt_sec))

# Fonction de moyenne mobile (alignée à droite)
rolling_mean <- function(x, k) {
  zoo::rollmean(x, k = k, fill = NA, align = "right")
}

# Appliquer le lissage
data <- data |>
  mutate(
    vo2_smooth30 = rolling_mean(vo2, k_30s),
    vo2_smooth60 = rolling_mean(vo2, k_60s),
    hr_smooth30 = rolling_mean(hr, k_30s),
    rer_smooth30 = rolling_mean(rer, k_30s),
    ve_smooth30 = rolling_mean(ve, k_30s)
  )

cat("Fenêtre de lissage 30s :", k_30s, "points\n")
cat("Fenêtre de lissage 60s :", k_60s, "points\n")
```

```{r}
#| label: visualisation-vo2-temps
#| fig-cap: "Évolution du VO₂ au cours du test incrémental"

# Identifier le point de VO₂ peak (lissé 30s)
vo2_peak_row <- data |>
  filter(!is.na(vo2_smooth30)) |>
  slice_max(vo2_smooth30, n = 1, with_ties = FALSE) |>
  mutate(time_min = time / 60)

# Graphique VO₂ vs temps
ggplot(data, aes(x = time / 60)) +
  geom_line(aes(y = vo2), linewidth = 0.35, alpha = 0.5, color = "#2C7FB8") +
  geom_line(aes(y = vo2_smooth30), linewidth = 0.7, color = "#D95F0E") +
  geom_point(
    data = vo2_peak_row,
    aes(x = time_min, y = vo2_smooth30),
    color = "#D95F0E",
    size = 2
  ) +
  geom_label(
    data = vo2_peak_row,
    aes(
      x = time_min,
      y = vo2_smooth30,
      label = paste0("VO₂peak(30s) = ", round(vo2_smooth30), " mL/min")
    ),
    hjust = 0,
    nudge_x = 0.2,
    size = 3
  ) +
  labs(
    x = "Temps (min)",
    y = "VO₂ (mL/min)",
    caption = paste0(
      "Bleu = brut; orange = moyenne mobile ~30 s (k=",
      k_30s,
      ")."
    )
  ) +
  theme_minimal(base_size = 11)
```

```{r}
#| label: visualisation-vo2-charge
#| fig-cap: "Relation entre le VO₂ et la charge externe"

# Relation VO₂ vs charge externe (puissance ou vitesse selon le protocole)
ggplot(data, aes(x = charge, y = vo2_smooth30)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 0.8) +
  labs(
    x = charge_label,
    y = "VO₂ (mL/min) – lissé ~30 s",
    caption = "Une forte dispersion ou relation non monotone suggère des artefacts."
  ) +
  theme_minimal(base_size = 11)
```

<!--
Justifiez ici :
- Pourquoi avez-vous choisi ces visualisations?
- Qu'observez-vous en termes de bruit vs signal?
- Y a-t-il des artefacts ou valeurs aberrantes?
-->

## Estimation du VO₂max {#sec-estimation}

Décrivez les méthodes utilisées pour estimer le VO₂max et justifiez vos choix.

```{r}
#| label: methodes-estimation

# ============================================================================
# Comparaison des méthodes d'estimation du VO₂max
# ============================================================================

# Méthode 1 : Pic brut
vo2_peak_raw <- max(data$vo2, na.rm = TRUE)

# Méthode 2 : Moyenne mobile 30 secondes
vo2_peak_30s <- max(data$vo2_smooth30, na.rm = TRUE)

# Méthode 3 : Moyenne mobile 60 secondes
vo2_peak_60s <- max(data$vo2_smooth60, na.rm = TRUE)

# Tableau comparatif
vo2_estimates <- tibble(
  Méthode = c(
    "Pic brut",
    paste0("Moyenne mobile ~30 s (k=", k_30s, ")"),
    paste0("Moyenne mobile ~60 s (k=", k_60s, ")")
  ),
  `VO₂ (mL/min)` = c(vo2_peak_raw, vo2_peak_30s, vo2_peak_60s),
  `VO₂/kg (mL/kg/min)` = round(`VO₂ (mL/min)` / participant$Weight_kg, 1),
  `Différence vs 30s (%)` = round(
    100 * (`VO₂ (mL/min)` - vo2_peak_30s) / vo2_peak_30s, 1
  )
)

knitr::kable(vo2_estimates, digits = 1, caption = "Comparaison des méthodes d'estimation")
```

<!--
Expliquez ici :
- Pourquoi avez-vous choisi ces méthodes spécifiques?
- Quelle fenêtre de lissage avez-vous utilisée et pourquoi?
- Quels autres paramètres avez-vous considérés?
-->

---

# Résultats

*Objectif : Présenter les graphiques et valeurs de manière claire et factuelle. Pas d'interprétation approfondie ici. (~2 pages)*

::: {.callout-note}
## Critère de la grille (3 pts)
**Analyse des données physiologiques** : Visualisation claire et pertinente, identification correcte des phases, distinction signal/bruit/artefacts.
:::

## Visualisation des données

```{r}
#| label: figure-principale
#| fig-cap: "Comparaison des données brutes et lissées du VO₂"

# Préparer les données pour le graphique
plot_vo2 <- data |>
  select(time, vo2, vo2_smooth30, vo2_smooth60) |>
  pivot_longer(
    cols = c(vo2, vo2_smooth30, vo2_smooth60),
    names_to = "serie",
    values_to = "value"
  ) |>
  mutate(
    serie = recode(
      serie,
      vo2 = "Brut",
      vo2_smooth30 = "Lissé ~30 s",
      vo2_smooth60 = "Lissé ~60 s"
    ),
    time_min = time / 60
  )

ggplot(plot_vo2, aes(x = time_min, y = value, color = serie)) +
  geom_line(linewidth = 0.6, alpha = 0.9) +
  scale_color_manual(
    values = c("Brut" = "#2C7FB8", "Lissé ~30 s" = "#D95F0E", "Lissé ~60 s" = "#31A354")
  ) +
  labs(x = "Temps (min)", y = "VO₂ (mL/min)", color = NULL) +
  theme_minimal(base_size = 11)
```

```{r}
#| label: figure-multiparametres
#| fig-cap: "VO₂, FC, RER et VE au cours du test"
#| fig-height: 8

# Préparer les données multi-paramètres
time_long <- bind_rows(
  data |> transmute(time_min = time / 60, metric = "VO₂ (mL/min)", value = vo2, value_smooth = vo2_smooth30),
  data |> transmute(time_min = time / 60, metric = "FC (bpm)", value = hr, value_smooth = hr_smooth30),
  data |> transmute(time_min = time / 60, metric = "RER (RQ)", value = rer, value_smooth = rer_smooth30),
  data |> transmute(time_min = time / 60, metric = "VE (L/min)", value = ve, value_smooth = ve_smooth30)
)

# Identifier les pics pour chaque métrique
peaks <- bind_rows(
  data |> filter(!is.na(vo2_smooth30)) |> slice_max(vo2_smooth30, n = 1, with_ties = FALSE) |>
    transmute(metric = "VO₂ (mL/min)", time_min = time / 60, value = vo2_smooth30, label = "VO₂peak"),
  data |> filter(!is.na(hr)) |> slice_max(hr, n = 1, with_ties = FALSE) |>
    transmute(metric = "FC (bpm)", time_min = time / 60, value = hr, label = "FCpeak"),
  data |> filter(!is.na(rer)) |> slice_max(rer, n = 1, with_ties = FALSE) |>
    transmute(metric = "RER (RQ)", time_min = time / 60, value = rer, label = "RERpeak"),
  data |> filter(!is.na(ve)) |> slice_max(ve, n = 1, with_ties = FALSE) |>
    transmute(metric = "VE (L/min)", time_min = time / 60, value = ve, label = "VEpeak")
)

ggplot(time_long, aes(x = time_min)) +
  geom_line(aes(y = value), linewidth = 0.35, alpha = 0.55, color = "#2C7FB8") +
  geom_line(aes(y = value_smooth), linewidth = 0.65, alpha = 0.9, color = "#D95F0E") +
  geom_point(data = peaks, aes(y = value), size = 2, color = "black") +
  geom_text(
    data = peaks,
    aes(y = value, label = label),
    nudge_x = 0.5,
    hjust = 0,
    size = 3
  ) +
  facet_wrap(~metric, ncol = 1, scales = "free_y") +
  labs(
    x = "Temps (min)",
    y = NULL,
    caption = "Bleu = brut; orange = moyenne mobile ~30 s."
  ) +
  theme_minimal(base_size = 11)
```

## Critères de maximalité (ACSM)

```{r}
#| label: criteres-maximalite

# ============================================================================
# Évaluation des critères de maximalité
# ============================================================================

# Récupérer les données du participant
age <- participant$Age
weight_kg <- participant$Weight_kg

# FCmax prédite (équation 220 - âge)
hr_max_pred <- 220 - age

# Seuils indicatifs
rer_threshold <- 1.10
hr_within_bpm <- 10

# Valeurs observées
rer_peak <- max(data$rer, na.rm = TRUE)
hr_peak <- max(data$hr, na.rm = TRUE)

# Tableau des critères
maximality_table <- tibble(
  Critère = c(
    "RER (RQ) peak observé",
    paste0("RER ≥ ", rer_threshold, " ?"),
    "FC peak observée (bpm)",
    "FCmax prédite (220 - âge)",
    paste0("FC à ≤ ", hr_within_bpm, " bpm de FCmax ?")
  ),
  Valeur = c(
    round(rer_peak, 2),
    ifelse(rer_peak >= rer_threshold, "Oui ✓", "Non ✗"),
    round(hr_peak),
    round(hr_max_pred),
    ifelse(abs(hr_peak - hr_max_pred) <= hr_within_bpm, "Oui ✓", "Non ✗")
  ),
  Note = c(
    NA,
    paste0("Seuil indicatif = ", rer_threshold),
    NA,
    "Équation classique (moins précise chez certaines populations)",
    paste0("Seuil indicatif = ±", hr_within_bpm, " bpm")
  )
)

knitr::kable(maximality_table, caption = "Évaluation des critères de maximalité")
```

## Valeurs obtenues

```{r}
#| label: tableau-resultats

# Lecture des résultats COSMED (si disponible)
results_cosmed <- tryCatch(
  read_excel(data_path, sheet = "Results"),
  error = function(e) NULL
)

# Tableau récapitulatif final
tbl_final <- tibble(
  Paramètre = c(
    "VO₂peak (pic brut)",
    "VO₂peak (lissé 30s)",
    "VO₂peak (lissé 60s)",
    "VO₂peak relatif (lissé 30s)",
    "FC peak",
    "RER peak",
    "VE peak"
  ),
  Valeur = c(
    paste0(round(vo2_peak_raw), " mL/min"),
    paste0(round(vo2_peak_30s), " mL/min"),
    paste0(round(vo2_peak_60s), " mL/min"),
    paste0(round(vo2_peak_30s / weight_kg, 1), " mL/kg/min"),
    paste0(round(hr_peak), " bpm"),
    round(rer_peak, 2),
    paste0(round(max(data$ve, na.rm = TRUE), 1), " L/min")
  )
)

knitr::kable(tbl_final, caption = "Résumé des valeurs physiologiques")
```

<!--
Observations factuelles à inclure :
- Valeurs de VO₂max obtenues par chaque méthode
- Différence entre les méthodes (en mL/min et en %)
- Description des phases identifiées dans le test
-->

---

# Discussion

*Objectif : Interpréter les résultats de manière critique et nuancée. (~2-3 pages)*

::: {.callout-note}
## Critère de la grille (3 pts)
**Interprétation physiologique** : Interprétation cohérente et nuancée, limites clairement identifiées, positionnement correct du VO₂max par rapport à l'endurance.
:::

## Comparaison des méthodes d'estimation

<!--
Discutez ici :
- Pourquoi les méthodes donnent-elles des valeurs différentes?
- Quel est l'impact du choix de la fenêtre de lissage?
- Quelle méthode préféreriez-vous dans un contexte clinique vs recherche?
-->

## Limites méthodologiques

<!--
Identifiez les sources d'incertitude :
- Variabilité de la mesure respiratoire
- Choix analytiques et leur impact
- Critères de maximalité (RER, FC, plateau?)
- Représentativité d'un test unique
-->

## VO₂max et performance d'endurance {#sec-vo2max-performance}

<!--
Discutez la relation VO₂max-performance :
- Le VO₂max prédit-il directement la performance?
- Quels autres facteurs sont importants (économie, seuils, cinétique)?
- Ouverture vers les laboratoires suivants
-->

---

# Conclusion

*Synthèse concise (~0.5 page)*

<!--
Message clé à retenir :
- Synthèse des principaux résultats
- Ce que ce laboratoire vous a appris sur l'analyse de données physiologiques
- Une phrase résumant le message central
-->

---

# Annexe – Utilisation de l'IA (si applicable)

*Si vous avez utilisé des outils d'IA (ChatGPT, Claude, Copilot, etc.), décrivez-les ici.*

<!--
Éléments à inclure :
- Outils utilisés et à quel moment
- Exemples de prompts utilisés
- Jugement critique : qu'avez-vous accepté/modifié/rejeté?
- Ce que l'IA a apporté et ses limites observées
-->

---

# Références

<!--
Listez vos sources si vous en avez utilisé.
Format suggéré : APA ou Vancouver
-->
